name: Lint Code, Check Format, Run Tests

on:
  workflow_dispatch:
  pull_request:
  push:

jobs:
  lint-code:
    runs-on: windows-latest
    steps:
      # Checkout your Git repo
      - uses: actions/checkout@v2
      # Install aftman and all aftman tools (rojo and mantle)
      - uses: ok-nick/setup-aftman@v0.4.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      # Generate Sourcemap
      - name: Install Wally Modules
        run: scripts/wally-install.cmd
      # Lint Types
      - name: Lint unit tests
        run: luau-lsp analyze --sourcemap sourcemap.json --base-luaurc .luaurc --defs testez.d.luau tests
      - name: Lint story books
        run: luau-lsp analyze --sourcemap sourcemap.json --base-luaurc .luaurc stories
      - name: Lint source code
        run: luau-lsp analyze --sourcemap sourcemap.json --base-luaurc .luaurc src

  check-format:
    runs-on: windows-latest
    steps:
      - name: Checkout your Git repo
        uses: actions/checkout@v2

      - name: Check Format [Source code]
        uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: 0.20.0
          args: --config-path stylua.toml --check src

      - name: Check Format [Story books]
        uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: 0.20.0
          args: --config-path stylua.toml --check stories

      - name: Check Format [Unit tests]
        uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: 0.20.0
          args: --config-path stylua.toml --check tests

      # Check Code Format
      # - uses: JohnnyMorganz/stylua-action@v4
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     version: 0.20.0 # NOTE: we recommend pinning to a specific version in case of formatting changes
      #     # CLI arguments
      #     args: --config-path stylua.toml --check src
      - name: Check Format unit tests
        run: stylua --config-path stylua.toml --check tests
      - name: Check Format story books
        run: stylua --config-path stylua.toml --check stories
      - name: Check Format source code
        run: stylua --config-path stylua.toml --check src
